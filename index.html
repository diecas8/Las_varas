<!DOCTYPE html>
<html>
<head>
    <title>Geoportal Tumaco</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <style>
        html, body, #map { height: 100%; margin: 0; }
        
        /* Botón flotante */
        #uploadBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: 0.3s;
        }
        
        #uploadBtn:hover { transform: scale(1.05); }
        
        /* Contenedor de carga */
        #uploadContainer {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        
        /* Estilos para capas */
        .leaflet-control-layers {
            top: 10px;
            right: 10px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Botón de carga -->
    <div id="uploadBtn">+</div>
    
    <!-- Contenedor de carga -->
    <div id="uploadContainer">
        <input type="file" id="fileInput" accept=".geojson,.kml" style="margin-bottom:10px">
        <select id="layerSelect"></select>
        <button onclick="toggleLayerVisibility()">Mostrar/Ocultar</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://npmcdn.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/omnivore/0.3.4/leaflet-omnivore.min.js"></script>

    <script>
        const map = L.map('map').setView([1.795, -78.825], 10);
        const baseLayers = {
            "Google Streets": L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                subdomains: ['mt0','mt1','mt2','mt3'],
                attribution: 'Google Maps'
            }).addTo(map),
            "Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri'
            })
        };

        // Capas predefinidas
        const predefinedLayers = {
            "Cabo Manglar": { file: 'Cabo_manglar.geojson', color: '#FF0000' },
            "Consejo Las Varas": { file: 'Consejo_las_varas.geojson', color: '#0000FF' },
            "Tumaco": { file: 'Tumaco.geojson', color: '#FFA500' }
        };

        const overlayLayers = {};
        const allLayers = {};

        // Cargar capas predefinidas
        Object.entries(predefinedLayers).forEach(([name, config]) => {
            fetch(config.file)
                .then(response => response.json())
                .then(data => {
                    const layer = L.geoJSON(data, {
                        style: { color: config.color, fillOpacity: 0.3 },
                        onEachFeature: (f, l) => l.bindPopup(f.properties.name || name)
                    });
                    overlayLayers[name] = layer;
                    allLayers[name] = layer;
                    updateLayerControl();
                });
        });

        // Control de capas
        const layerControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);
        L.control.attribution({ prefix: 'Elaborado por: Diego Castaño, Esp. Sig.' }).addTo(map);

        // Función para actualizar control de capas
        function updateLayerControl() {
            layerControl.remove();
            layerControl.addTo(map);
            document.getElementById('layerSelect').innerHTML = 
                Object.keys(allLayers).map(name => `<option value="${name}">${name}</option>`).join('');
        }

        // Evento para mostrar/ocultar contenedor
        document.getElementById('uploadBtn').addEventListener('click', () => {
            const container = document.getElementById('uploadContainer');
            container.style.display = container.style.display === 'block' ? 'none' : 'block';
        });

        // Carga de archivos
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function() {
                try {
                    const format = file.name.split('.').pop().toLowerCase();
                    let layer;
                    
                    if (format === 'kml') {
                        layer = omnivore.kml.parse(reader.result);
                    } else {
                        const geojson = JSON.parse(reader.result);
                        layer = L.geoJSON(geojson);
                    }

                    const color = '#' + Math.floor(Math.random()*16777215).toString(16);
                    const name = file.name.split('.')[0];
                    
                    layer.setStyle({ color: color, fillOpacity: 0.3 });
                    layer.bindPopup(name);
                    
                    overlayLayers[name] = layer;
                    allLayers[name] = layer;
                    updateLayerControl();
                    
                } catch (error) {
                    alert('Error al cargar el archivo');
                    console.error(error);
                }
            };

            if (file) reader.readAsText(file);
        });

        // Función para alternar visibilidad
        function toggleLayerVisibility() {
            const selectedLayer = document.getElementById('layerSelect').value;
            const layer = allLayers[selectedLayer];
            
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            } else {
                map.addLayer(layer);
            }
        }
    </script>
</body>
</html>
