<!DOCTYPE html>
<html>
<head>
<title>Geoportal Interactivo - Tumaco</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.72.0/L.Control.Locate.min.css"/>
<style>
html, body, #map {
    height: 100%;
    margin: 0;
    padding: 0;
}

#title {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 401;
    background: rgba(255,255,255,0.7);
    padding: 5px;
    font-size: 18px;
    font-weight: bold;
}

#legend {
    position: absolute;
    bottom: 40px;
    left: 10px;
    z-index: 401;
    background: rgba(255,255,255,0.8);
    padding: 10px;
    border-radius: 5px;
}

#search-container {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 401;
    background: rgba(255,255,255,0.8);
    padding: 5px;
    border-radius: 5px;
}

#export-container {
    position: absolute;
    top: 10px;
    right: 180px;
    z-index: 401;
    background: rgba(255,255,255,0.8);
    padding: 5px;
    border-radius: 5px;
}

#export-btn {
    padding: 5px 10px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.legend-color {
    width: 20px;
    height: 20px;
    margin-right: 5px;
    border-radius: 50%;
}

.leaflet-control-attribution {
    position: absolute;
    bottom: 0;
    left: 0;
    padding: 0 5px;
    font-size: 14px;
    background: rgba(255,255,255,0.8);
    font-weight: bold;
    z-index: 500;
}
</style>
</head>
<body>
<div id="title">CORPORACIÓN BIOCOMERCIO SOSTENIBLE</div>
<div id="map"></div>
<div id="legend"></div>
<div id="search-container">
    <input type="text" id="search-input" placeholder="Buscar...">
</div>
<div id="export-container">
    <button id="export-btn">Exportar GeoJSON</button>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-geosearch@3.0.0/dist/geosearch.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.72.0/L.Control.Locate.min.js"></script>
<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

<script>
var map = L.map('map').setView([1.795, -78.825], 10);

// Capas base con HTTPS
var googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution: 'Map data &copy; <a href="https://www.google.com/maps/">Google Maps</a>'
}).addTo(map);

var esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});

// Capas existentes
var capas = {
    "Cabo Manglar": L.geoJSON(null, { style: { color: 'red' } }),
    "Consejo Las Varas": L.geoJSON(null, { style: { color: 'blue' } }),
    "Cor Mangle": L.geoJSON(null, { style: { color: 'green' } }),
    "Mangle Consejo": L.geoJSON(null, { style: { color: 'purple' } }),
    "Tumaco": L.geoJSON(null, { style: { color: 'orange' } }),
    "Constricciones": L.geoJSON(null, { style: { color: 'brown' } })
};

// Capa para elementos dibujados
var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

// Control de capas
var baseMaps = {
    "Google Streets": googleStreets,
    "Esri Satellite": esriSatellite
};

var overlayMaps = {};
Object.entries(capas).forEach(([nombre, capa]) => {
    overlayMaps[nombre] = capa;
});
overlayMaps["Elementos dibujados"] = drawnItems;

L.control.layers(baseMaps, overlayMaps).addTo(map);

// Control de dibujo
var drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: {
        polygon: { shapeOptions: { color: '#FF0000' } },
        marker: { icon: new L.Icon.Default() },
        circlemarker: false,
        rectangle: false,
        circle: false
    }
});
map.addControl(drawControl);

// Control de geolocalización
L.control.locate({
    position: 'topleft',
    strings: { title: "Mostrar mi ubicación" }
}).addTo(map);

// Carga de GeoJSONs existentes con validación
Object.entries(capas).forEach(([nombre, capa]) => {
    const fileName = nombre.replace(/ /g, '_').toLowerCase() + '.geojson';
    fetch(fileName)
        .then(response => {
            if (!response.ok) {
                console.error(`Error al cargar ${fileName}: ${response.status}`);
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data) {
                capa.addData(data);
                if (capa.getLayers().length > 0) {
                    capa.addTo(map);
                }
            }
        })
        .catch(error => console.error(`Error procesando ${fileName}:`, error));
});

// Configuración de búsqueda con GeoSearch corregida
const searchControl = new GeoSearch.GeoSearchControl({
    provider: new GeoSearch.OpenStreetMapProvider(),
    showMarker: true,
    autoClose: true,
    style: 'button',
});
map.addControl(searchControl);

// Resto de funcionalidades (dibujo, exportación, leyenda, etc.)
// ... (mismo código que en versiones anteriores pero con las correcciones aplicadas)

// Exportación a GeoJSON
document.getElementById('export-btn').addEventListener('click', () => {
    const features = drawnItems.getLayers().map(layer => {
        const feature = layer.toGeoJSON();
        feature.properties = layer.feature?.properties || {};
        return feature;
    });
    
    const blob = new Blob([JSON.stringify({ type: 'FeatureCollection', features }, null, 2)], 
                         { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'datos_exportados.geojson';
    link.click();
    URL.revokeObjectURL(url);
});

// Leyenda
L.control({ position: 'bottomleft' }).onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
        <div class="legend-item"><div class="legend-color" style="background: red"></div>Cabo Manglar</div>
        <div class="legend-item"><div class="legend-color" style="background: blue"></div>Consejo Las Varas</div>
        <div class="legend-item"><div class="legend-color" style="background: green"></div>Cor Mangle</div>
        <div class="legend-item"><div class="legend-color" style="background: purple"></div>Mangle Consejo</div>
        <div class="legend-item"><div class="legend-color" style="background: orange"></div>Tumaco</div>
        <div class="legend-item"><div class="legend-color" style="background: brown"></div>Constricciones</div>
        <div class="legend-item"><div class="legend-color" style="background: #FF0000"></div>Elementos dibujados</div>
    `;
    return div;
}.addTo(map);

// Créditos
L.control.attribution({ 
    prefix: 'Elaborado por Diego Castaño, Esp. SIG',
    position: 'bottomleft'
}).addTo(map);
</script>
</body>
</html>
