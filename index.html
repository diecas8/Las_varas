<!DOCTYPE html>
<html>
<head>
    <title>Geoportal Tumaco - Diego Castaño SIG</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhESMIAAAAABJRU5ErkJggg==" type="image/x-icon">
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #title {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 1rem 2rem;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 1.5rem;
            font-weight: 600;
        }

        #toolbar {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
        }

        .file-input {
            margin-bottom: 1rem;
        }

        .layer-list {
            list-style: none;
            padding-left: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .layer-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        #attribution {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="title">Geoportal Tumaco</div>
    <div id="map"></div>
    
    <div id="toolbar">
        <div class="tool-section">
            <h4>Cargar Datos Geográficos</h4>
            <input type="file" id="fileInput" class="file-input" accept=".geojson,.json,.kml">
        </div>
        
        <div class="tool-section">
            <h4>Capas Cargadas</h4>
            <ul id="layerList" class="layer-list"></ul>
        </div>
    </div>

    <div id="attribution">
        Elaborado por: Diego Castaño, Esp. SIG
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://npmcdn.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/omnivore/0.3.4/leaflet-omnivore.min.js"></script>

    <script>
        const map = L.map('map', {
            center: [1.8073, -78.8208],
            zoom: 12
        });

        // Capa base inicial
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Control de capas
        const baseLayers = {
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            })
        };

        const overlayLayers = {};
        const userLayers = {};

        L.control.layers(baseLayers, overlayLayers).addTo(map);

        // Carga de archivos
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function() {
                try {
                    const format = file.name.split('.').pop().toLowerCase();
                    let layer;

                    if (format === 'kml') {
                        layer = omnivore.kml.parse(reader.result);
                    } else {
                        const geojson = JSON.parse(reader.result);
                        layer = L.geoJSON(geojson, {
                            style: {
                                color: '#' + Math.floor(Math.random()*16777215).toString(16),
                                weight: 2,
                                fillOpacity: 0.3
                            },
                            onEachFeature: (feature, l) => {
                                l.bindPopup(`<b>${feature.properties.name || 'Predio'}</b>`);
                            }
                        });
                    }

                    const layerName = file.name.split('.')[0];
                    layer.name = layerName;
                    userLayers[layerName] = layer;

                    // Añadir al mapa y controles
                    layer.addTo(map);
                    overlayLayers[layerName] = layer;
                    updateLayerControl();

                    // Añadir a lista visual
                    const listItem = document.createElement('li');
                    listItem.className = 'layer-item';
                    listItem.innerHTML = `
                        <div class="layer-color" style="background-color: ${layer.options.color}"></div>
                        ${layerName}
                        <button onclick="removeLayer('${layerName}')" style="margin-left:auto">Eliminar</button>
                    `;
                    document.getElementById('layerList').appendChild(listItem);
                    
                } catch (error) {
                    alert('Error al procesar el archivo: ' + error.message);
                    console.error(error);
                }
            };
            reader.readAsText(file);
        });

        // Funciones de gestión
        function updateLayerControl() {
            map.eachLayer(layer => {
                if (layer instanceof L.GeoJSON || layer instanceof L.KML) {
                    if (!overlayLayers[layer.name]) {
                        overlayLayers[layer.name] = layer;
                    }
                }
            });
            L.control.layers(baseLayers, overlayLayers).addTo(map);
        }

        function removeLayer(name) {
            map.removeLayer(userLayers[name]);
            delete userLayers[name];
            delete overlayLayers[name];
            document.querySelector(`li:contains(${name})`).remove();
            updateLayerControl();
        }

        // Búsqueda geográfica
        const searchControl = new GeoSearch.GeoSearchControl({
            provider: new GeoSearch.OpenStreetMapProvider(),
            style: 'button',
            showMarker: true,
            autoClose: true
        });
        map.addControl(searchControl);
    </script>
</body>
</html>
