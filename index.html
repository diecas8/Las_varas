<!DOCTYPE html>
<html>
<head>
    <title>Geoportal Interactivo - Tumaco</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhESMIAAAAABJRU5ErkJggg==" type="image/x-icon">
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #title {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 1.2rem;
            font-weight: 600;
        }

        #toolbar {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tool-section {
            margin-bottom: 1rem;
        }

        .file-input {
            margin-bottom: 1rem;
        }

        .layer-list {
            list-style: none;
            padding-left: 0;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .layer-color {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        #search-container {
            position: absolute;
            top: 1.2rem;
            right: 1rem;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 0.5rem;
            border-radius: 25px;
            display: flex;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #search-input {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 25px;
            margin-right: 0.5rem;
        }

        .leaflet-control-geosearch {
            flex: 1;
        }

        #legend {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.8;
        }

        .legend-item {
            display: flex;
            align-items: center;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div id="title">CORPORACIÓN BIOCOMERCIO SOSTENIBLE</div>
    <div id="map"></div>
    
    <div id="toolbar">
        <div class="tool-section">
            <h4>Cargar Datos</h4>
            <input type="file" id="fileInput" class="file-input" accept=".geojson,.json,.kml">
        </div>
        
        <div class="tool-section">
            <h4>Capas Cargadas</h4>
            <ul id="layerList" class="layer-list"></ul>
        </div>
        
        <div class="tool-section analysis-tool">
            <h4>Herramientas de Análisis</h4>
            <select id="bufferLayer">
                <option value="">Seleccionar capa para buffer</option>
            </select>
            <input type="number" id="bufferDistance" placeholder="Radio (metros)">
            <button onclick="createBuffer()">Crear Buffer</button>
        </div>
        
        <div class="tool-section analysis-tool">
            <select id="intersectLayer1">
                <option value="">Capa 1</option>
            </select>
            <select id="intersectLayer2">
                <option value="">Capa 2</option>
            </select>
            <button onclick="checkIntersection()">Ver Intersección</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://npmcdn.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/omnivore/0.3.4/leaflet-omnivore.min.js"></script>

    <script>
        const map = L.map('map', {
            center: [1.795, -78.825],
            zoom: 10
        });

        // Capas base con HTTPS
        const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Google Maps'
        }).addTo(map);

        const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri'
        });

        // Capas predefinidas
        const predefinedLayers = {
            "Cabo Manglar": { file: 'Cabo_manglar.geojson', color: '#FF0000' },
            "Consejo Las Varas": { file: 'Consejo_las_varas.geojson', color: '#0000FF' },
            "Cor Mangle": { file: 'Cor_mangle.geojson', color: '#00FF00' },
            "Mangle Consejo": { file: 'Mangle_consejo.geojson', color: '#800080' },
            "Tumaco": { file: 'Tumaco.geojson', color: '#FFA500' },
            "Constricciones": { file: 'constricciones.geojson', color: '#A52A2A' }
        };

        // Capas del usuario
        const userLayers = {};
        let currentLayerId = 0;

        // Control de capas
        const baseLayers = {
            "Google Streets": googleStreets,
            "Satélite Esri": esriSatellite
        };

        const overlayLayers = {};

        // Cargar capas predefinidas
        Object.entries(predefinedLayers).forEach(([name, config]) => {
            fetch(config.file)
                .then(response => response.json())
                .then(data => {
                    const layer = L.geoJSON(data, {
                        style: {
                            color: config.color,
                            weight: 2,
                            fillColor: config.color,
                            fillOpacity: 0.3
                        },
                        onEachFeature: (feature, layer) => {
                            layer.bindPopup(`<b>${feature.properties.name || name}</b>`);
                        }
                    });
                    
                    overlayLayers[name] = layer;
                    layer.addTo(map);
                })
                .catch(error => console.error(`Error cargando ${name}:`, error));
        });

        // Control de capas
        const layerControl = L.control.layers(baseLayers, overlayLayers).addTo(map);
        L.control.attribution({ 
            position: 'bottomright',
            prefix: 'Elaborado por: Diego Castaño, Esp. Sig.'
        }).addTo(map);

        // Función para añadir capa al mapa
        function addLayerToMap(layer, name, color) {
            const layerId = `userLayer_${currentLayerId++}`;
            userLayers[layerId] = layer;
            
            overlayLayers[name] = layer;
            layer.addTo(map);
            
            const layerItem = document.createElement('li');
            layerItem.className = 'layer-item';
            layerItem.innerHTML = `
                <div class="layer-color" style="background-color: ${color}"></div>
                <span>${name}</span>
                <button onclick="removeLayer('${layerId}')">×</button>
                <button onclick="moveLayerUp('${layerId}')">▲</button>
                <button onclick="moveLayerDown('${layerId}')">▼</button>
            `;
            document.getElementById('layerList').appendChild(layerItem);
            layerControl.addOverlay(layer, name);
        }

        // Carga de archivos
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function() {
                try {
                    const format = file.name.split('.').pop().toLowerCase();
                    let layer;
                    
                    if (format === 'kml') {
                        layer = omnivore.kml.parse(reader.result);
                    } else {
                        const geojson = JSON.parse(reader.result);
                        layer = L.geoJSON(geojson);
                    }

                    const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
                    const layerName = file.name.split('.')[0];
                    
                    layer.setStyle({ 
                        color: randomColor,
                        weight: 2,
                        fillColor: randomColor,
                        fillOpacity: 0.3
                    });
                    
                    addLayerToMap(layer, layerName, randomColor);
                    
                } catch (error) {
                    alert('Error al cargar el archivo');
                    console.error(error);
                }
            };

            if (file) {
                reader.readAsText(file);
            }
        });

        // Gestión de capas
        function removeLayer(layerId) {
            const layer = userLayers[layerId];
            map.removeLayer(layer);
            delete userLayers[layerId];
            document.querySelector(`li:has(button[onclick="removeLayer('${layerId}')"])`).remove();
            layerControl.removeLayer(layer);
        }

        function moveLayerUp(layerId) {
            const layer = userLayers[layerId];
            layer.bringToFront();
        }

        function moveLayerDown(layerId) {
            const layer = userLayers[layerId];
            layer.bringToBack();
        }

        // Herramientas de análisis
        function createBuffer() {
            const layerId = document.getElementById('bufferLayer').value;
            const distance = document.getElementById('bufferDistance').value;
            
            if (!layerId || !distance) return;

            const layer = userLayers[layerId] || overlayLayers[Object.keys(overlayLayers)[layerId]];
            const buffered = turf.buffer(layer.toGeoJSON(), distance, {units: 'meters'});
            
            L.geoJSON(buffered, {
                style: { color: '#ff0000', fillColor: '#ff0000' }
            }).addTo(map);
        }

        function checkIntersection() {
            const layer1Id = document.getElementById('intersectLayer1').value;
            const layer2Id = document.getElementById('intersectLayer2').value;
            
            if (!layer1Id || !layer2Id) return;

            const layer1 = (userLayers[layer1Id] || overlayLayers[Object.keys(overlayLayers)[layer1Id]]).toGeoJSON();
            const layer2 = (userLayers[layer2Id] || overlayLayers[Object.keys(overlayLayers)[layer2Id]]).toGeoJSON();
            
            const intersection = turf.intersect(layer1, layer2);
            
            if (intersection) {
                L.geoJSON(intersection, {
                    style: { color: '#00ff00', fillColor: '#00ff00' }
                }).addTo(map);
            } else {
                alert('No hay intersección');
            }
        }

        // Actualizar opciones de análisis
        function updateAnalysisOptions() {
            const layerSelects = document.querySelectorAll('.analysis-tool select');
            layerSelects.forEach(select => {
                select.innerHTML = '<option value="">Seleccionar capa</option>';
                Object.entries(overlayLayers).forEach(([name, layer], index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = name;
                    select.appendChild(option);
                });
                Object.entries(userLayers).forEach(([id, layer]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = Object.keys(overlayLayers).find(key => overlayLayers[key] === layer) || 'Capa cargada';
                    select.appendChild(option);
                });
            });
        }

        // Control de búsqueda
        const searchControl = new GeoSearch.GeoSearchControl({
            provider: new GeoSearch.OpenStreetMapProvider(),
            style: 'button',
            showMarker: true,
            marker: {
                icon: L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png'
                })
            },
            autoClose: true,
            keepResult: true
        });

        map.addControl(searchControl);
        updateAnalysisOptions();

        // Leyenda
        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = () => {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<h4>Leyenda</h4>';
            
            Object.entries(predefinedLayers).forEach(([name, config]) => {
                div.innerHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${config.color}"></div>
                        ${name}
                    </div>
                `;
            });
            
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>
